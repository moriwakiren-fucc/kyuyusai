<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Video Branching</title>
  <style>
    /* 画面いっぱいに動画を表示する最低限のスタイル */
    html, body { margin:0; padding:0; height:100%; width:100%; background:black; overflow:hidden; }
    video { width:100%; height:100%; object-fit:cover; display:block; background:black; }
  </style>
</head>
<body>
  <!-- 初期は自動再生（ただし muted にしてブラウザの制限を回避） -->
  <video id="player" autoplay muted playsinline></video>

  <script>
    const video = document.getElementById("player");

    // キーグループ（小文字で判定）
    const leftKeys  = ["q","w","a","s","z","x"];
    const rightKeys = ["p","o","+","l","?"," >".trim()]; // '>' を含める
    const digitSeq  = ["1","2","3","4","5","6","7","8","9","0"];

    // 分岐ルール（ファイル名は同フォルダ内）
    const transitions = {
      "01gamestart.mp4": { left: "1lc.mp4", right: "1rf.mp4" },
      "1lc.mp4":         { left: "2lc.mp4", right: "2rf.mp4" },
      "2lc.mp4":         { left: "3lf.mp4", right: "3rc.mp4" }
      // 必要ならここにさらに追加してください
    };

    // 同レベルの左右対応（逆分岐で即切り替えるため）
    const counterparts = {
      "1rf.mp4": "1lc.mp4",
      "1lc.mp4": "1rf.mp4",
      "2rf.mp4": "2lc.mp4",
      "2lc.mp4": "2rf.mp4",
      "3rc.mp4": "3lf.mp4",
      "3lf.mp4": "3rc.mp4"
    };

    let nextVideo = null;       // 再生終了時に再生する予約（通常分岐）
    let lastBranch = null;      // "left" または "right"（直近で選択した分岐）
    let seqIndex = 0;           // digitSeq の現在の進捗（0..10）
    let reverseUnlocked = false;// true のとき逆分岐（即中断切替）が有効

    // ページ読み込み時にほぼ同時に opening を再生
    playVideo("00opening.mp4");

    // 再生関数（通常の再生・予約解除）
    function playVideo(filename) {
      video.src = filename;
      video.currentTime = 0;
      video.load();
      video.play().catch(err => console.warn("play()ブロック:", err));
      nextVideo = null;
    }

    // 即中断して切り替える（現在の再生を止めて即再生）
    function playImmediate(filename) {
      try {
        video.pause();
      } catch(e){}
      video.src = filename;
      video.currentTime = 0;
      video.load();
      video.play().catch(err => console.warn("即再生でplay()ブロック:", err));
      nextVideo = null;
    }

    // 現在の動画と分岐（left/right）から遷移先を返す
    function decideNext(branch) {
      const cur = (video.src || "").split("/").pop();
      const map = transitions[cur];
      if (map && map[branch]) return map[branch];
      return null;
    }

    // 現在の動画に左右の対応があれば返す（逆分岐用）
    function getCounterpart() {
      const cur = (video.src || "").split("/").pop();
      return counterparts[cur] || null;
    }

    // digit sequence を処理（連続で 1→2→...→0 を踏めば unlock）
    function handleDigitKey(d) {
      if (d === digitSeq[seqIndex]) {
        seqIndex++;
        if (seqIndex === digitSeq.length) {
          reverseUnlocked = true;
          seqIndex = 0;
          console.log("逆分岐モードを解除（有効）");
        }
      } else {
        // 間違った場合はリセット。ただし '1' が押された場合は index=1 にする（連続再スタート）
        seqIndex = (d === digitSeq[0]) ? 1 : 0;
      }
    }

    // キー入力ハンドラ
    document.addEventListener("keydown", (e) => {
      const raw = e.key;
      const key = String(raw).toLowerCase();

      // Space: opening を中断してゲーム開始
      if (e.code === "Space" || key === " ") {
        // ユーザー操作があったので音ありに切り替える
        video.muted = false;
        playImmediate("01gamestart.mp4");
        return;
      }

      // Digit sequence の判定（'1'..'9','0'）
      if (/^[0-9]$/.test(key)) {
        handleDigitKey(key);
        return;
      }

      // 左キー群
      if (leftKeys.includes(key)) {
        // 逆分岐モードかつ現在が右側の動画 -> 即中断で左右入れ替え
        if (reverseUnlocked) {
          const cp = getCounterpart();
          if (cp && cp.includes("lc") || cp && cp.includes("lf")) {
            playImmediate(cp);
            reverseUnlocked = false; // 使用したらリセット
            seqIndex = 0;
            lastBranch = "left";
            return;
          }
        }

        // 通常の左分岐（予約または即再生）
        const nv = decideNext("left");
        if (nv) {
          if (video.ended) playImmediate(nv);
          else nextVideo = nv;
          lastBranch = "left";
        }
        return;
      }

      // 右キー群
      if (rightKeys.includes(key)) {
        // 逆分岐モードかつ現在が左側の動画 -> 即中断で左右入れ替え
        if (reverseUnlocked) {
          const cp = getCounterpart();
          if (cp && (cp.includes("rf") || cp.includes("rc"))) {
            playImmediate(cp);
            reverseUnlocked = false;
            seqIndex = 0;
            lastBranch = "right";
            return;
          }
        }

        // 通常の右分岐（予約または即再生）
        const nv = decideNext("right");
        if (nv) {
          if (video.ended) playImmediate(nv);
          else nextVideo = nv;
          lastBranch = "right";
        }
        return;
      }

      // その他のキーは無視（必要ならここに拡張）
    });

    // 再生終了時の処理（予約があれば再生）
    video.addEventListener("ended", () => {
      if (nextVideo) {
        playImmediate(nextVideo);
      }
    });
  </script>
</body>
</html>
